'use client';

import { useState, useCallback } from 'react';
import { useDropzone } from 'react-dropzone';
import Image from 'next/image';
import toast from 'react-hot-toast';

export default function DiagnosePage() {
  const [image, setImage] = useState<string | null>(null);
  const [plantType, setPlantType] = useState('');
  const [symptoms, setSymptoms] = useState('');

  // Handle file drop
  const onDrop = useCallback((acceptedFiles: File[]) => {
    const file = acceptedFiles[0];
    if (file && file.type.startsWith('image/')) {
      if (file.size > 10 * 1024 * 1024) { // 10MB limit
        toast.error('Image size should be less than 10MB');
        return;
      }
      const reader = new FileReader();
      reader.onloadend = () => {
        setImage(reader.result as string);
        toast.success('Image uploaded successfully!');
      };
      reader.readAsDataURL(file);
    } else {
      toast.error('Please upload a valid image file (PNG, JPG)');
    }
  }, []);

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: {
      'image/png': ['.png'],
      'image/jpeg': ['.jpg', '.jpeg']
    },
    maxFiles: 1,
    maxSize: 10 * 1024 * 1024 // 10MB
  });

  // Handle camera access
  const startCamera = async () => {
    try {
      const mediaStream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
      });
      setStream(mediaStream);
      setIsUsingCamera(true);
      toast.success('Camera accessed successfully!');
    } catch (error) {
      toast.error('Could not access camera');
      console.error('Error accessing camera:', error);
    }
  };

  const stopCamera = () => {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      setStream(null);
    }
    setIsUsingCamera(false);
  };

  const capturePhoto = () => {
    const video = document.querySelector('video');
    const canvas = document.createElement('canvas');
    if (video) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d')?.drawImage(video, 0, 0);
      const photoData = canvas.toDataURL('image/jpeg');
      setImage(photoData);
      stopCamera();
      toast.success('Photo captured successfully!');
    }
  };

  // Handle diagnosis
  const analyzePlant = async () => {
    if (!image) {
      toast.error('Please upload or capture an image first');
      return;
    }

    // TODO: Implement API call to analyze plant
    toast.loading('Analyzing plant...');
    try {
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 2000));
      setDiagnosis('Your plant appears to be healthy. Keep up the good care!');
      toast.success('Analysis complete!');
    } catch (error) {
      toast.error('Failed to analyze plant');
      console.error('Error analyzing plant:', error);
    }
  };

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold text-gray-800 mb-8">Plant Diagnosis</h1>
      
      <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div className="space-y-6">
          {!isUsingCamera && !image && (
            <div
              {...getRootProps()}
              className={`border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-colors
                ${isDragActive ? 'border-green-500 bg-green-50' : 'border-gray-300 hover:border-green-400'}`}
            >
              <input {...getInputProps()} />
              <div className="space-y-4">
                <div className="text-gray-600">
                  {isDragActive ? (
                    <p>Drop your image here</p>
                  ) : (
                    <div>
                      <p className="text-lg mb-2">Drag and drop your plant image here</p>
                      <p className="text-sm text-gray-500">or click to select a file</p>
                    </div>
                  )}
                </div>
                <div className="flex justify-center">
                  <Image
                    src="/plant-leaves-logo.svg"
                    alt="Upload"
                    width={64}
                    height={64}
                    className="opacity-50"
                  />
                </div>
              </div>
            </div>
          )}

          {!isUsingCamera && (
            <button
              onClick={startCamera}
              className="w-full py-3 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 
                transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            >
              {image ? 'Take Another Photo' : 'Use Camera'}
            </button>
          )}

          {isUsingCamera && (
            <div className="space-y-4">
              <div className="relative aspect-video rounded-lg overflow-hidden bg-black">
                <video
                  autoPlay
                  playsInline
                  ref={video => {
                    if (video && stream) video.srcObject = stream;
                  }}
                  className="w-full h-full object-contain"
                />
              </div>
              <div className="flex space-x-4">
                <button
                  onClick={capturePhoto}
                  className="flex-1 py-3 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 
                    transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                >
                  Capture Photo
                </button>
                <button
                  onClick={stopCamera}
                  className="flex-1 py-3 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 
                    transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
                >
                  Cancel
                </button>
              </div>
            </div>
          )}

          {image && !isUsingCamera && (
            <div className="space-y-4">
              <div className="relative aspect-video rounded-lg overflow-hidden bg-gray-100">
                <Image
                  src={image}
                  alt="Uploaded plant"
                  fill
                  className="object-contain"
                />
              </div>
              <div className="flex space-x-4">
                <button
                  onClick={() => setImage(null)}
                  className="flex-1 py-3 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 
                    transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
                >
                  Remove Image
                </button>
                <button
                  onClick={analyzePlant}
                  className="flex-1 py-3 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 
                    transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                >
                  Analyze Plant
                </button>
              </div>
            </div>
          )}

          {diagnosis && (
            <div className="mt-8 p-6 bg-green-50 rounded-lg">
              <h2 className="text-xl font-semibold text-gray-800 mb-4">Diagnosis Result</h2>
              <p className="text-gray-600">{diagnosis}</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
